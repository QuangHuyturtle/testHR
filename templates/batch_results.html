<!-- templates/batch_results.html -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-success mb-4">
            <i class="fas fa-chart-bar me-3"></i>Kết quả Dự đoán Hàng loạt
        </h1>
    </div>
</div>

<!-- Summary Report -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ report.total_candidates }}</h3>
                <p class="mb-0">Tổng ứng viên</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ report.suitable_candidates }}</h3>
                <p class="mb-0">Ứng viên phù hợp</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ "%.1f"|format(report.suitable_percentage) }}%</h3>
                <p class="mb-0">Tỷ lệ phù hợp</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ report.high_confidence_suitable }}</h3>
                <p class="mb-0">Tin cậy cao</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Chi tiết Kết quả</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Mã ứng viên</th>
                                <th>Kết quả</th>
                                <th>Độ tin cậy</th>
                                <th>Xác suất phù hợp</th>
                                <th>Khuyến nghị</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results.to_dict('records') %}
                            <tr>
                                <td>{{ result.candidate_id }}</td>
                                <td>
                                    {% if result.prediction == 'Suitable' %}
                                        <span class="badge bg-success">Phù hợp</span>
                                    {% else %}
                                        <span class="badge bg-warning">Chưa phù hợp</span>
                                    {% endif %}
                                </td>
                                <td>{{ "%.1f"|format(result.confidence * 100) }}%</td>
                                <td>{{ "%.1f"|format(result.probability_suitable * 100) }}%</td>
                                <td>
                                    <small>
                                        {% if result.recommendation == 'Highly recommended for interview' %}
                                            Rất khuyến khích phỏng vấn
                                        {% elif result.recommendation == 'Recommended for interview' %}
                                            Khuyến khích phỏng vấn
                                        {% elif result.recommendation == 'Consider for interview with caution' %}
                                            Cân nhắc thận trọng
                                        {% elif result.recommendation == 'Not recommended' %}
                                            Không khuyến khích
                                        {% else %}
                                            Cần đánh giá thêm
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <a href="/batch" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </a>
                    <button class="btn btn-primary" onclick="exportResults()">
                        <i class="fas fa-download me-2"></i>Tải xuống Kết quả
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function exportResults() {
    // Tạo CSV từ kết quả và download
    let csv = 'Mã ứng viên,Kết quả,Độ tin cậy,Xác suất phù hợp,Khuyến nghị\n';
    {% for result in results.to_dict('records') %}
    csv += '{{ result.candidate_id }},{{ result.prediction }},{{ "%.3f"|format(result.confidence) }},{{ "%.3f"|format(result.probability_suitable) }},"{% if result.recommendation == "Highly recommended for interview" %}Rất khuyến khích phỏng vấn{% elif result.recommendation == "Recommended for interview" %}Khuyến khích phỏng vấn{% elif result.recommendation == "Consider for interview with caution" %}Cân nhắc thận trọng{% elif result.recommendation == "Not recommended" %}Không khuyến khích{% else %}Cần đánh giá thêm{% endif %}"\n';
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'ket_qua_du_doan_' + new Date().toISOString().slice(0,10) + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}